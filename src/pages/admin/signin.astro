---
import '@/styles/admin/signin.scss'

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (accessToken && refreshToken) {
  return redirect("/admin");
}
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Iniciar sesión</title>
  </head>
  <body>
    <div class="wrap">
      <div class="card" id="card">
        <div class="header">
          <h1>Acceso</h1>
          <div class="meta">Área privada</div>
        </div>
        <div class="content">
          <form id="form" action="/api/auth/signin" method="post" enctype="application/x-www-form-urlencoded"> 
            <div class="field">
              <label for="email">Correo electrónico</label>
              <input type="email" id="email" name="email" required />
            </div>
            <div class="field">
              <label for="password">Contraseña</label>
              <input type="password" id="password" name="password" required />
            </div>
            <div class="actions">
              <button class="primary" type="submit" id="submit">Iniciar sesión</button>
            </div>
            <div class="error" id="error" hidden></div>
          </form>
        </div>
      </div>
    </div>
    <script>
      const form = document.getElementById('form')!;
      const errorBox = document.getElementById('error')!;
      const password = document.getElementById('password')!;
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        errorBox.hidden = true;
        password.classList.remove('input-error');
        const body = new URLSearchParams(new FormData(form as HTMLFormElement) as any);
        const res = await fetch((form as any).action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (res.redirected) {
          window.location.href = res.url;
          return;
        }
        if (!res.ok) {
          let msg = 'Error de autenticación';
          try {
            const data: any = await res.json();
            if (data && data.error) msg = data.error;
          } catch {
            try { msg = await res.text(); } catch {}
          }
          errorBox.textContent = msg;
          errorBox.hidden = false;
          password.classList.add('input-error');
          return;
        }
        window.location.href = '/admin';
      });
    </script>
  </body>
  </html>

