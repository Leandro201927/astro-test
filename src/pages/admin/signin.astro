---
const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (accessToken && refreshToken) {
  return redirect("/admin");
}
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iniciar sesión</title>
    <style>
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
          Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        background: #f7f7f7;
        color: #111;
      }
      .wrap {
        min-height: 100%;
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .card {
        width: 100%;
        max-width: 420px;
        background: #fff;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      }
      .card h1 {
        font-size: 20px;
        margin: 0;
      }
      .header { padding: 20px; border-bottom: 1px solid #eee; }
      .content { padding: 20px; }
      .field { margin-bottom: 14px; }
      label { display: block; font-size: 13px; color: #555; margin-bottom: 6px; }
      input[type="email"], input[type="password"] {
        width: calc(100% - 25px);
        max-width: 100%;
        height: 40px;
        padding: 0 12px;
        border: 1px solid #dcdcdc;
        border-radius: 8px;
        background: #fff;
        color: #111;
        outline: none;
      }
      .input-error { border-color: #b00020 !important; }
      input:focus { border-color: #b5b5b5; }
      .actions { margin-top: 16px; display: flex; gap: 10px; align-items: center; }
      button {
        appearance: none;
        height: 40px;
        padding: 0 16px;
        border: 1px solid #dcdcdc;
        border-radius: 8px;
        background: #f2f2f2;
        color: #111;
        cursor: pointer;
      }
      button.primary { background: #111; color: #fff; border-color: #111; }
      .meta { margin-top: 12px; font-size: 12px; color: #666; }
      .error { margin-top: 10px; color: #b00020; font-size: 13px; }
      .footer { padding: 16px 20px; border-top: 1px solid #eee; font-size: 12px; color: #666; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card" id="card">
        <div class="header">
          <h1>Acceso</h1>
          <div class="meta">Área privada</div>
        </div>
        <div class="content">
          <form id="form" action="/api/auth/signin" method="post" enctype="application/x-www-form-urlencoded"> 
            <div class="field">
              <label for="email">Correo electrónico</label>
              <input type="email" id="email" name="email" required />
            </div>
            <div class="field">
              <label for="password">Contraseña</label>
              <input type="password" id="password" name="password" required />
            </div>
            <div class="actions">
              <button class="primary" type="submit" id="submit">Iniciar sesión</button>
            </div>
            <div class="error" id="error" hidden></div>
          </form>
        </div>
      </div>
    </div>
    <script>
      const form = document.getElementById('form');
      const errorBox = document.getElementById('error');
      const password = document.getElementById('password');
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        errorBox.hidden = true;
        password.classList.remove('input-error');
        const body = new URLSearchParams(new FormData(form));
        const res = await fetch(form.action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        if (res.redirected) {
          window.location.href = res.url;
          return;
        }
        if (!res.ok) {
          let msg = 'Error de autenticación';
          try {
            const data = await res.json();
            if (data && data.error) msg = data.error;
          } catch {
            try { msg = await res.text(); } catch {}
          }
          errorBox.textContent = msg;
          errorBox.hidden = false;
          password.classList.add('input-error');
          return;
        }
        window.location.href = '/admin';
      });
    </script>
  </body>
  </html>

