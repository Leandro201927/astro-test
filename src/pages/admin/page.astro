---
export const prerender = false;

import "@/styles/admin/index.scss";
import PageEditor from "@/components/admin/PageEditor";
import { listPages, getPageByPath, getGlobalComponents } from "@/lib/kvPages";
import { supabase } from "@/lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/admin/signin");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
    return Astro.redirect("/admin/signin");
  }
} catch {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/admin/signin");
}

const slugKeys = await listPages(Astro.locals as App.Locals);
const pages = [] as any[];
for (const key of slugKeys) {
  const page = await getPageByPath(Astro.locals as App.Locals, key);
  if (page) pages.push(page);
}

import globalComponentsDefault from "@/data/global.json";
const globalComponentsKV = await getGlobalComponents(
  Astro.locals as App.Locals,
);
const globalComponents = globalComponentsKV || globalComponentsDefault;

const canChange = true;
const email = session.data.user?.email;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Editor de PÃ¡gina</title>
  </head>
  <body>
    <PageEditor
      client:load
      initialPages={pages}
      initialUser={session.data.user}
      globalComponents={globalComponents}
      canChange={canChange}
      userEmail={email}
    />
  </body>
</html>
