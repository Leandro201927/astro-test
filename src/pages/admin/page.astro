---
export const prerender = false;

import '@/styles/admin/index.scss'
import PageEditor from '@/components/admin/PageEditor'
import { listPages, getPageByPath } from '@/lib/kvPages'
import { supabase } from "@/lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/admin/signin");
}

let session;
try {
  session = await supabase.auth.setSession({ refresh_token: refreshToken.value, access_token: accessToken.value });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
    return Astro.redirect("/admin/signin");
  }
} catch {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/admin/signin");
}

const slugKeys = await listPages(Astro.locals as App.Locals)
const pages = [] as any[]
for (const key of slugKeys) {
  const page = await getPageByPath(Astro.locals as App.Locals, key)
  if (page) pages.push(page)
}

const canChange = true
const email = session.data.user?.email
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Editor de P√°gina</title>
  </head>
  <body>
    <header class="header">
      <div class="container header-content">
        <h1>üéõÔ∏è Editor</h1>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="user-info">
            <div class="avatar">
              {email?.charAt(0).toUpperCase()}
            </div>
            <div>
              <div style="font-weight: 500;">{email?.split('@')[0]}</div>
              <div style="font-size: 12px; color: #666;">{email}</div>
            </div>
          </div>
          <a href="/api/auth/signout" class="logout">Cerrar sesi√≥n</a>
        </div>
      </div>
    </header>
    <main class="main">
      <div class="container">
        <PageEditor client:load initialPages={pages} canChange={canChange} />
      </div>
    </main>
  </body>
  </html>